<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Apreensões</title>
  <link rel="stylesheet" href="arquivos/style.css" />
  <link rel="icon" href="arquivos/Logo.png" type="image/png" />
  <style>
    #mapContainer {
      display: none;
      text-align: center;
      margin-top: 20px;
      cursor: pointer;
    }

    #mapCanvas {
      border: 3px solid #444;
      border-radius: 8px;
    }

    /* Overlay full-screen */
    #mapOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
    }

    #mapOverlay canvas {
      max-width: 95%;
      max-height: 90%;
      border: 3px solid #444;
      border-radius: 8px;
      cursor: crosshair;
    }

    #closeMapOverlay {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: red;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <h1>Registro de Apreensões</h1>
  </header>

  <div class="main-container">
    <div class="left">
      <img src="arquivos/Logo.png" alt="Polícia Civil SP" />
    </div>

    <div class="right">
      <a id="discordLogin" href="#" class="discord-button">Entrar com Discord</a>
      <div id="loginStatus" class="status-text" style="display:none;"></div>
    </div>
  </div>

  <section class="form-section" style="display:none;">
    <form id="apreensaoForm">
      <h2>Registro de Apreensões</h2>

      <label for="responsavel">Responsável</label>
      <input id="responsavel" type="text" name="responsavel" required readonly />

      <label for="materiais">Materiais Apreendidos</label>
      <div id="materiaisContainer"></div>
      <button type="button" id="addMaterial">Adicionar Material</button>

      <label for="participantes">Participantes</label>
      <input id="participantes" type="text" name="participantes" placeholder="Digite os participantes separados por vírgula" />

      <label for="files">Evidências (máx 10 arquivos, ≤10MB cada, total ≤25MB)</label>
      <input id="files" type="file" name="files" multiple accept="image/*,video/*" />
      <small id="mbStatus">Total: 0 MB / 25 MB</small>

      <div id="mapContainer">
        <h3>Clique na imagem para ampliar</h3>
        <canvas id="mapCanvas"></canvas>
        <input type="hidden" id="mapX" name="mapX" />
        <input type="hidden" id="mapY" name="mapY" />
        <input type="hidden" id="mapImage" name="mapImage" />
      </div>

      <button type="submit">Enviar</button>
      <div id="status"></div>
    </form>
  </section>

  <!-- Overlay full-screen para mapa -->
  <div id="mapOverlay">
    <canvas id="mapCanvasOverlay"></canvas>
    <button id="closeMapOverlay">Fechar</button>
  </div>

  <footer>
    &copy; 2025 Polícia Civil do Estado de São Paulo. Todos os direitos reservados.
  </footer>

  <!-- Script principal -->
  <script src="arquivos/apreensao.js"></script>

  <!-- Script do mapa com overlay -->
  <script>
    const canvasNormal = document.getElementById("mapCanvas");
    const mapContainer = document.getElementById("mapContainer");
    const img = new Image();
    img.src = "arquivos/imagem_radar.png";

    const overlay = document.getElementById("mapOverlay");
    const canvasOverlay = document.getElementById("mapCanvasOverlay");
    const ctxOverlay = canvasOverlay.getContext("2d");
    const closeBtn = document.getElementById("closeMapOverlay");

    let isDrawing = false, startX, startY, radius = 0;

    img.onload = () => {
      // Canvas normal
      canvasNormal.width = img.width / 4; // pequena para visualização
      canvasNormal.height = img.height / 4;
      const ctxNormal = canvasNormal.getContext("2d");
      ctxNormal.drawImage(img, 0, 0, canvasNormal.width, canvasNormal.height);
      mapContainer.style.display = "block";
    };

    // Abrir overlay full-screen ao clicar na imagem normal
    mapContainer.addEventListener("click", () => {
      overlay.style.display = "flex";
      const scale = Math.min(window.innerWidth * 0.95 / img.width, window.innerHeight * 0.85 / img.height);
      canvasOverlay.width = img.width * scale;
      canvasOverlay.height = img.height * scale;
      ctxOverlay.drawImage(img, 0, 0, canvasOverlay.width, canvasOverlay.height);
      canvasOverlay.dataset.scale = scale;
    });

    closeBtn.addEventListener("click", () => {
      overlay.style.display = "none";
    });

    canvasOverlay.addEventListener("mousedown", e => {
      const rect = canvasOverlay.getBoundingClientRect();
      const scale = canvasOverlay.dataset.scale;
      startX = (e.clientX - rect.left) / scale;
      startY = (e.clientY - rect.top) / scale;
      isDrawing = true;
    });

    canvasOverlay.addEventListener("mousemove", e => {
      if (!isDrawing) return;
      const rect = canvasOverlay.getBoundingClientRect();
      const scale = canvasOverlay.dataset.scale;
      const currentX = (e.clientX - rect.left) / scale;
      const currentY = (e.clientY - rect.top) / scale;
      radius = Math.sqrt((currentX - startX)**2 + (currentY - startY)**2);

      ctxOverlay.drawImage(img, 0, 0, canvasOverlay.width, canvasOverlay.height);
      ctxOverlay.strokeStyle = "red";
      ctxOverlay.lineWidth = 4;
      ctxOverlay.beginPath();
      ctxOverlay.arc(startX * scale, startY * scale, radius * scale, 0, Math.PI*2);
      ctxOverlay.stroke();
    });

    canvasOverlay.addEventListener("mouseup", async () => {
      if (!isDrawing) return;
      isDrawing = false;
      document.getElementById("mapX").value = Math.round(startX);
      document.getElementById("mapY").value = Math.round(startY);

      const blob = await new Promise(resolve => canvasOverlay.toBlob(resolve, "image/png"));
      const reader = new FileReader();
      reader.onloadend = () => {
        document.getElementById("mapImage").value = reader.result;
      };
      reader.readAsDataURL(blob);
    });
  </script>
</body>
</html>
