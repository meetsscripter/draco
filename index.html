<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Registro de Investiga√ß√£o</title>
<link rel="stylesheet" href="arquivos/style.css">
</head>
<body>
<header>
  <img src="arquivos/Logo.png" alt="Pol√≠cia Civil SP">
  <h1>Registro de Investiga√ß√£o</h1>
</header>

<div class="container">
  <form id="investigationForm">
    <label>Investigador respons√°vel</label>
    <input type="text" name="investigator" required>

    <label>Resumo do caso</label>
    <textarea name="summary" rows="3" required></textarea>

    <label>Observa√ß√µes adicionais</label>
    <textarea name="observations" rows="3"></textarea>

    <label>Evid√™ncias (m√°x 10 arquivos, ‚â§10MB cada, total ‚â§25MB)</label>
    <input type="file" id="files" multiple accept="image/*,video/*">
    <small id="mbStatus">Total: 0 MB / 25 MB</small>

    <button type="submit">Enviar</button>
    <div id="status"></div>
  </form>
</div>

<script>
const filesInput = document.getElementById('files');
const mbStatus = document.getElementById('mbStatus');

filesInput.addEventListener('change', () => {
  let totalMB = 0;
  for (const file of filesInput.files) {
    totalMB += file.size / (1024*1024);
  }
  totalMB = Math.round(totalMB * 100) / 100;
  mbStatus.innerText = `Total: ${totalMB} MB / 25 MB`;

  // Verifica limites
  for (const file of filesInput.files) {
    if (file.size > 10*1024*1024) {
      alert(`‚ùå Arquivo ${file.name} maior que 10MB!`);
      filesInput.value = "";
      mbStatus.innerText = `Total: 0 MB / 25 MB`;
      return;
    }
  }

  if (totalMB > 25) {
    alert("‚ùå Total de arquivos ultrapassa 25MB!");
    filesInput.value = "";
    mbStatus.innerText = `Total: 0 MB / 25 MB`;
  }
});

async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

document.getElementById('investigationForm').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const status = document.getElementById('status');
  const btn = form.querySelector('button[type="submit"]');

  // Solicita o c√≥digo com prompt
  const code = prompt("üîë Digite o c√≥digo de envio:");
  if (!code || code.trim() === "") {
    status.innerText = "‚ùå C√≥digo de envio n√£o informado";
    return;
  }

  btn.disabled = true;
  status.innerText = "‚è≥ Enviando...";

  const investigator = form.investigator.value;
  const summary = form.summary.value;
  const observations = form.observations.value;
  const files = filesInput.files;

  if (files.length > 10) {
    status.innerText = "‚ùå M√°ximo 10 arquivos";
    btn.disabled = false;
    return;
  }

  const filesData = [];
  let totalMB = 0;
  for (const file of files) {
    if (file.size > 10*1024*1024) {
      status.innerText = `‚ùå Arquivo ${file.name} maior que 10MB`;
      btn.disabled = false;
      return;
    }
    totalMB += file.size / (1024*1024);
    if (totalMB > 25) {
      status.innerText = "‚ùå Total de arquivos ultrapassa 25MB";
      btn.disabled = false;
      return;
    }
    const base64 = await fileToBase64(file);
    filesData.push({ name: file.name, type: file.type, base64 });
  }

  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbyzeswk3YEZH7yJe4OZO4RFqtqVuwVhNLs2ZWQ0_5dw4wUrcMCnW41UmiJ-crhfDmEuuA/exec', {
      method: 'POST',
      body: JSON.stringify({ investigator, summary, observations, files: filesData, code })
    });
    const res = await response.json();
    if(res.status==='ok') {
      status.innerText = `‚úÖ Enviado! ${filesData.length} arquivo(s)`;
      form.reset();
      mbStatus.innerText = `Total: 0 MB / 25 MB`;
    } else {
      status.innerText = "‚ùå " + (res.message||JSON.stringify(res));
    }
  } catch(err) {
    status.innerText = "‚ùå Falha na comunica√ß√£o: " + err.message;
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>

